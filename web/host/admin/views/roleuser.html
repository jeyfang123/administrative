<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title> - 部门人员</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link href="/hadmin/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/hadmin/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="/hadmin/css/plugins/chosen/chosen.css" rel="stylesheet">

    <link href="/hadmin/css/animate.css" rel="stylesheet">
    <link href="/hadmin/css/style.css?v=4.1.0" rel="stylesheet">

    <link href="/admin/css/roleuser.css" rel="stylesheet" >

    <!-- Sweet Alert -->
    <link href="/hadmin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <!--dropzone-->
    <link href="/plugins/bower_components/dropzone-master/dist/dropzone.css" rel="stylesheet" type="text/css" />
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content  animated fadeInRight">
        <div class="row">
            <div class="col-sm-8">
                <div class="ibox">
                    <div class="ibox-content">
                        <h2>部门人员</h2>
                        <div class="input-group">
                            <input type="text" id="keyword" placeholder="查找人员" class="input form-control">
                            <span class="input-group-btn">
                                        <button type="button" id="search" class="btn btn btn-primary"> <i class="fa fa-search"></i> 搜索</button>
                                </span>
                        </div>
                        <div class="clients-list">
                            <ul class="nav nav-tabs">
                                <span class="pull-right small text-muted">{{ data.userTotal }} 位部门人员</span>
                                <li class="active"><a data-toggle="tab" href="#tab-1"><i class="fa fa-user"></i> 人员列表</a>
                                </li>
                                <li class=""><a data-toggle="tab" href="#tab-2"><i class="fa fa-briefcase"></i> 新建账户</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div id="tab-1" class="tab-pane active">
                                    <div class="full-height-scroll">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <tbody class="role-user-tbody">

                                                </tbody>
                                            </table>
                                            <div id="userpage" class="js-pages">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="tab-2" class="tab-pane">
                                    <div class="new-role-user">
                                        <form class="form-horizontal form-new-roleuser">
                                            <div class="form-group">
                                                <h3 class="col-sm-12 control-label" style="text-align: center">注册部门人员帐号</h3>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">帐号</label>

                                                <div class="col-sm-10">
                                                    <input type="text" name="username" class="form-control username" required="" aria-required="true">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">初始密码</label>

                                                <div class="col-sm-10">
                                                    <input type="text" disabled="" value="123456" class="form-control">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">所属部门</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group" style="width: 100%;">
                                                        <select name="role" data-placeholder="选择部门..." class="chosen-select role" style="width:100%;" required="" aria-required="true">
                                                            <option value="">请选择部门</option>
                                                            {% for item in data.department %}
                                                                <option value="{{ item.role_id }}" hassubinfo="true">{{ item.rolename }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">个人头像</label>
                                                <div class="col-sm-10">
                                                    <div id="dropzone" class="dropzone dz-clickable">
                                                        <div class="dz-default dz-message" style="margin-top: 12%;">拖动文件至该处(或点击此处)上传图片</div>
                                                        <input type="hidden" name="file" class="avatar-file">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group" >
                                                <div class="col-sm-12" style="text-align: right;">
                                                    <button class="btn btn-primary add-new-roleuser" style="width: 10%" type="button">
                                                        <i class="fa fa-check"></i>提交
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="ibox ">

                    <div class="ibox-content">
                        <div class="tab-content">
                            <div id="contact-1" class="tab-pane active">
                                <div class="row m-b-lg">
                                    <div class="col-lg-4 text-center">
                                        <h2 class="user-detail-name"> </h2>

                                        <div class="m-b-sm user-detail-ava-area">
                                            <img alt="image" class="img-circle user-detail-ava" src="/admin/img/avatar/default.png" style="width: 62px">
                                        </div>
                                    </div>
                                    <div class="col-lg-8">
                                        <h3>基本信息</h3>
                                        <ul class="list-group clear-list">
                                            <li class="list-group-item fist-item">
                                                <span class="pull-right user-detail-create">  </span> 注册日期
                                            </li>
                                            <li class="list-group-item">
                                                <span class="pull-right user-detail-nick">  </span> 姓名
                                            </li>
                                            <li class="list-group-item">
                                                <span class="pull-right user-detail-phone">  </span> 手机
                                            </li>
                                            <li class="list-group-item">
                                                <span class="pull-right user-detail-email">  </span> 邮箱
                                            </li>
                                            <li class="list-group-item">
                                                <span class="pull-right user-detail-role">  </span> 所属部门
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="client-detail">
                                    <div class="full-height-scroll">
                                        <strong>其他信息</strong>
                                        <ul class="list-group clear-list">
                                            <li class="list-group-item fist-item">
                                                <span class="pull-right user-detail-deal"> </span> 办结数目
                                            </li>
                                            <li class="list-group-item">
                                                <span class="pull-right user-detail-undeal">  </span> 待处理数目
                                            </li>
                                        </ul>
                                        <hr/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- 全局js -->
    <script src="/hadmin/js/jquery.min.js?v=2.1.4"></script>
    <script src="/hadmin/js/bootstrap.min.js?v=3.3.6"></script>

    <script src="/hadmin/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="/plugins/bower_components/cookie/jquery.cookie.min.js"></script>
    <!-- Chosen -->
    <script src="/hadmin/js/plugins/chosen/chosen.jquery.js"></script>
    <!-- Sweet alert -->
    <script src="/hadmin/js/plugins/sweetalert/sweetalert.min.js"></script>
    <!--validate-->
    <script src="/hadmin/js/plugins/validate/jquery.validate.min.js"></script>
    <script src="/hadmin/js/plugins/validate/messages_zh.min.js"></script>
    <script src="/public/js/validate.per.js"></script>
    <!-- DROPZONE -->
    <script src="/plugins/bower_components/dropzone-master/dist/dropzone.js"></script>
    <!--twbsPagination-->
    <script type="text/javascript" src="/plugins/bower_components/twbsPagination/jquery.twbsPagination.min.js"></script>
    <!-- 自定义js -->
    <script src="/hadmin/js/content.js?v=1.0.0"></script>

    <script src="/public/js/public.js"></script>
    <script src="/admin/js/model.js"></script>

    <script>
        $(function () {
            $('.full-height-scroll').slimScroll({
                height: '100%'
            });

            $("#search").click(function () {
                initHtml(1,true);
            });
            $("#keyword").keydown(function(event){
                if (event.keyCode == 13) {
                    $('#search').click();
                    event.preventDefault();
                }
            });

            initHtml(1,true);
            function initHtml(page,ispagination) {
                var title = $("#keyword").val();
                Model.getRoleUser({
                    'keywords':title,
                    'page':page,
                    'pagesize':15
                },function(data) {
                    if(data.code === CODE_SUCCESS){
                        appendHtml(data,page,ispagination);
                    }else{
                        swal({
                            title: "出错了！",
                            text: '请重试'
                        });
                    }
                });
            }
            function appendHtml(data,page,ispagination) {
                var list = data.data;
                var length = list.length;
                var total = data.count;
                var pagesize = 15;
                var pageTotal =Math.ceil(total/pagesize);
                var html = '';
                for(var i=0;i<length;i++){
                    html += '<tr class="user-row" data-id="'+ list[i]['depart_user_id'] +'"><td class="client-avatar"><img alt="image" src="'+ (list[i]['avatar'] ? list[i]['avatar'] : "/admin/img/avatar/default.png") +'"> </td>';
                    html += '<td><a data-toggle="tab" href="#'+ list[i]['depart_user_id'] +'" class="client-link">'+ list[i]['nickname'] +'</a></td>';
                    html += '<td> '+ list[i]['rolename'] +' </td>';
                    html += '<td class="contact-type"><i class="'+ list[i]['tag'] +'"> </i></td>';
                    html += '<td>'+ list[i].contact +'</td>';
                    html += '<td>'+ list[i].createtime +'</td>';
                    html += '</tr>';
                }
                $(".role-user-tbody").html(html);
                if(ispagination){
                    $("#userpage").html('<ul class="pagination"style="float:right"></ul>');
                }
                if(0!=pageTotal){
                    $('#userpage .pagination').twbsPagination({
                        startPage:1,
                        currentPage:page,
                        totalPages: pageTotal,
                        visiblePages: 7,
                        first: '首页',
                        prev: '前一页',
                        next: '下一页',
                        last: '尾页',
                        lother: '共'+ pageTotal +'页',
                        onPageClick: function (event, page) {
                            initHtml(page,false);
                        }
                    });
                }
            }

            $('.chosen-container.chosen-container-single').css('width',$('.chosen-select').css('width'));
            
            $('.role-user-tbody').on('click','.user-row',function () {
                var userId = $(this).attr('data-id');
                Model.getUserDetail({
                    'userId':userId
                },function (res) {
                    var detail = res.data.detail;
                    var undeal = res.data.undeal;
                    var finished = res.data.finished;
                    $('.user-detail-name').text(detail.nickname);
                    $('.user-detail-create').text(detail.createtime);
                    $('.user-detail-email').text(detail.email);
                    $('.user-detail-phone').text(detail.phone);
                    $('.user-detail-role').text(detail.rolename);
                    $('.user-detail-nick').text(detail.nickname);
                    $('.user-detail-deal').text(finished);
                    $('.user-detail-undeal').text(undeal);
                    var img = '<img alt="image" class=" user-detail-ava" src="'+ (detail['avatar'] ? detail['avatar'] : "/admin/img/avatar/default.png") +'" style="width: 62px">'
                    $('.user-detail-ava').replaceWith(img);
                });
            })

            Dropzone.autoDiscover = false;
            $('#dropzone').dropzone({
                url: "/public/common/imgUpload?type=roleuser&token="+$.cookie('token'), //必须填写
                method:"post",
                paramName:"avatar", //默认为file
                maxFiles:1,//一次性上传的文件数量上限
                maxFilesize: 2, //MB
                acceptedFiles: ".jpg,.jpeg,.png", //上传的类型
                addRemoveLinks:true,
                dictMaxFilesExceeded: "您最多只能上传1个文件！",
                dictResponseError: '文件上传失败!',
                dictInvalidFileType: "你不能上传该类型文件,文件类型只能是.jpg,.jpeg,.png。",
                dictFallbackMessage:"浏览器不受支持",
                dictFileTooBig:"文件过大上传文件最大支持.",
                dictRemoveFile:"删除文件",
                parallelUploads:1,
                autoProcessQueue:true,
                init: function() {
                    this.on("success", function(file,res) {
                        res = JSON.parse(res);
                        if(res['code'] == CODE_SUCCESS){
                            $('.dz-progress').hide();
                            var path = res['file'];
                            $('.avatar-file').val(path);
                        }
                        else{
                            swal({
                                title: "上传失败",
                                text: res['error']
                            });
                        }
                    });
                    this.on("removedfile",function(file){
                        $('.dz-progress').show();
                        $('.avatar-file').val('');
                    });
                }
            });

            function JqValidate() {
                return $('.form-new-roleuser').validate({
                    rules:{
                        username:'required',
                        role:{
                            required:true,
                            minlength: 36
                        },
                    },
                    messages:{
                        username:'必填',
                        role:'必填',
                    }
                });
            }
            
            $('button.add-new-roleuser').click(function () {
                if(JqValidate().form()){
                    var username = $.trim($('.username').val());
                    var role = $('.role').val();
                    var avatar = $('.avatar-file').val();
                    if(role.length != 36){
                        swal({
                            title: "警告！",
                            text: '您未选择部门'
                        });
                        return;
                    }
                    if(avatar == ''){
                        swal({
                            title: "警告！",
                            text: '您未上传照片'
                        });
                        return;
                    }
                    Model.addRoleuser({
                        'username':username,
                        'role':role,
                        'avatar':avatar
                    },function (res) {
                        if(res.code == CODE_SUCCESS){
                            swal({
                                title: "Success",
                                text: "添加成功",
                                type: "success"
                            });
                            $('.username').val('');
                        }
                        else{
                            swal({
                                title: "添加失败",
                                text: res.msg
                            });
                        }
                    },{},function () {
                        swal({
                            title: "添加失败",
                            text: '服务器未响应'
                        });
                    })
                }
            })


        });

        var config = {
            '.chosen-select': {},
            '.chosen-select-deselect': {
                allow_single_deselect: true
            },
            '.chosen-select-no-single': {
                disable_search_threshold: 10
            },
            '.chosen-select-no-results': {
                no_results_text: 'Oops, nothing found!'
            },
            '.chosen-select-width': {
                width: "95%"
            }
        }
        for (var selector in config) {
            $(selector).chosen(config[selector]);
        }


    </script>

    
    

</body>

</html>
